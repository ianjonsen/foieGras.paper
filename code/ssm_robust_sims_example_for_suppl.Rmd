---
title: "ex32_old"
author: "Ian Jonsen"
date: "`r Sys.Date()`"
output: html_document
---

```{r knitr_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, message=FALSE, warning=FALSE}
require(tidyverse, quietly = TRUE)
require(foieGras, quietly = TRUE)
```

## 3.2 | Assessing SSM robustness with simulated data
Using the `sim` function, we simulate animal movement tracks with a variety of plausible movement patterns. We use these simulated data to examine the accuracy of SSM fits to data generated by processes that differ from the `rw` and `crw` process models use in `fit_ssm`. While we regard this example as an atypical use of the track simulation function, it nonetheless illustrates one of the many possible uses of such a simulation tool. Another, more common application of track simulation as a preparatory step for a habitat usage analysis is highlighted in example 3.4. 

We used `sim` to generate 50 animal tracks from each of the following 3 process models: 1) the same `crw` process used in `fit_ssm`; 2) a 2-state `crw` with stochastic switching between movement states; 3) the movement persistence model, where persistence in directionality and speed varies as a random walk. All tracks were simulated for 300 regular, 6-h time steps and a randomly selected Argos Kalman Filter error ellipse was assigned to each simulated location independent of the movement process. Further details on the track simulations are in Supplement xx. Representative simulated tracks for each movement process are shown in (Fig. \ref{fig:ex2}a-c). We then used `fit_ssm` to fit both the `rw` and `crw` SSM's to these simulation tracks and calculated the Root Mean Squared Error of the SSM fits using the Euclidean distance between each SSM-estimated location and the corresponding simulated location (without Argos error). As the spatial scale of the simulated tracks differed among the 3 movement processes, we normalized RMSE values by the mean step length calculated across all tracks within each movement process type.

Regardless of the simulated movement process, the `crw` SSM consistently provided more accurate fits than the `rw` SSM (Fig. \ref{fig:ex2}d-f). Although fits to the simulated 2-state `crw` and `mpm` tracks were less accurate than to the `crw` tracks, the differences were not large and goodness-of-fit based on prediction residuals were reasonable (Supplement xx). We advocate that in most cases the `crw` SSM should be preferred for quality-control of Argos tracking data, however the `rw` SSM may converge more reliably when fitting to problematic data (e.g., tracks with frequent and relatively large temporal data gaps).

```{r ex2, echo=FALSE, message=FALSE, results='markup', fig.width=9, fig.height=10, cache=TRUE, fig.cap="\\label{fig:ex2} Four example tracks simulated from the correlated random walk process model (`crw`, a), a 2-state `crw` model (b), and the movement persistence model (`mpm`, c). Normalised Root Mean Squared Errors of state-space models fit with either the `crw` or random walk (`rw`) process model to 50 simulated `crw` tracks (d), 50 simulated `2-state crw` tracks (e), and 50 simulated `mpm` tracks (f). The SSM fits using the `crw` process model were consistently more accurate than those using the `rw` process model, regardless of the type of movements simulated."}

load("../data/ex32_simdat.RData")

m1 <- ggplot(scrw %>% 
         filter(id %in% c(1,26,39,43))
       ) + 
  geom_point(aes(lon,lat, col = factor(id)), size = 0.2) + 
  scale_colour_manual(values = wesanderson::wes_palette("Darjeeling2"),
                      guide = "none") +
  ylab("Latitude") +
  xlab("") +
  theme_minimal()

m2 <- ggplot(s2crw %>% 
               filter(id %in% c(2,28,32,49))
             ) + 
  geom_point(aes(lon,lat, col = factor(id)), size = 0.2) + 
  scale_colour_manual(values = wesanderson::wes_palette("Darjeeling2"),
                      guide = "none") +
  ylab("") +
  xlab("Longitude") +
  theme_minimal()

m3 <- ggplot(smpm %>% 
               filter(id %in% c(3,18,26,49))
             ) + 
  geom_point(aes(lon,lat, col = factor(id)), size = 0.2) + 
  scale_colour_manual(values = wesanderson::wes_palette("Darjeeling2"),
                      guide = "none") +
  ylab("") +
  xlab("") +
  theme_minimal()

load("../data/ex32_rmse.RData")
levels(rmse$SSM) <- c("CRW","RW")

## plot overall normalised rmse's
p1 <- ggplot(rmse %>% filter(sim == "CRW"), aes(SSM, nrmse, fill = SSM)) + 
  scale_fill_manual(values = wesanderson::wes_palette("Darjeeling2")) + #from wesanderson Zissou1 palette 
  geom_boxplot(colour = grey(0.6)) + 
  ylim(0, 1.2) +
  theme_minimal() + 
  xlab(element_blank()) +
  ylab("Normalised RMSE") +
  theme(legend.position = "none")

p2 <- ggplot(rmse %>% filter(sim == "2-CRW"), aes(SSM, nrmse, fill = SSM)) + 
  scale_fill_manual(values = wesanderson::wes_palette("Darjeeling2")) + #from wesanderson Zissou1 palette 
  geom_boxplot(colour = grey(0.6)) + 
  ylim(0, 1.2) +
  theme_minimal() + 
  xlab("SSM process model") +
  ylab(element_blank()) +
  theme(legend.position = "none")

p3 <- ggplot(rmse %>% filter(sim == "MPM"), aes(SSM, nrmse, fill = SSM)) + 
  scale_fill_manual(values = wesanderson::wes_palette("Darjeeling2")) + #from wesanderson Zissou1 palette c("#3B9AB2", "#E1AF00")
  geom_boxplot(colour = grey(0.6)) + 
  ylim(0, 1.2) +
  theme_minimal() + 
  xlab(element_blank()) +
  ylab(element_blank()) +
  theme(legend.position = "none")

(m1 + m2 + m3) /
(p1 + p2 + p3) +
  plot_layout(heights = c(2,4)) +
  plot_annotation(tag_levels = "a")
```
