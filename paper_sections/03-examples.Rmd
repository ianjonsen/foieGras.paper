# 3 | Examples

```{r part_3_premble, include=FALSE}
#### Code for part 3: Examples ####
```
We illustrate the main capabilities of `foieGras` through a series of examples using real and simulated tracking data. These examples are for demonstration purposes and not intended as a comprehensive guide for conducting analyses with `foieGras`. Complete code for reproducing the examples and for gaining a deeper understanding of `foieGras` functions are provided as supplements.

## 3.1 | Southern Elephant seal - SSM validation with prediction residuals
We use a subadult male southern elephant seal track included in `foieGras` (`sese1`), sourced from from the Australian Integrated Marine Observing System (IMOS; data publicly available via [imos.aodn.org.au](http://imos.aodn.org.au)) deployments at Iles Kerguelen in collaboration with the French IPEV and SNO-MEMO programmes. The data are temporally irregular Argos Least-Squares based locations, 73 \% of which are in the poorest location quality classes: A and B. We fit both the `rw` and `crw` models using `fit_ssm` with a speed filter threshold (`vmax`) of 4 ms^-1^ and a 12-h time step. We calculate prediction residuals using `osar`, and then use the generic `plot` method for `osar` residuals to assess and compare the model fits (Fig. \ref{fig:ex1}). 

The plots of predicted states on top of the observations suggests both models yield similar fits (Fig. \ref{fig:ex1}a,b), however, there are marked trends in the time-series of residuals for the `rw` model fit (Fig. \ref{fig:ex1}c) and the `rw` ACF's reveal consistent positive autocorrelation in the prediction residuals (Fig. \ref{fig:ex1}e). The corresponding `crw` prediction residuals show no apparent trends through time and have relatively little autocorrelation (Fig. \ref{fig:ex1}d,f), implying that the `crw` provides a better fit to the data.

```{r sese1 SSM, eval=FALSE, echo=FALSE}
fit.rw <- fit_ssm(sese2, vmax=4, model="rw", time.step=12, control=ssm_control(verbose=0))
res.rw <- osar(fit.rw[1,])

fit.crw <- fit_ssm(sese2, vmax=4, model="crw", time.step=12, control=ssm_control(verbose=0))
res.crw <- osar(fit.crw[1,])
```

```{r ex1, echo=FALSE, message=FALSE, results='markup', fig.width=7, fig.height=6, cache=TRUE, fig.cap="\\label{fig:ex1} Selected diagnostic plots for assessing `rw` (a,c,e) and `crw` (b,d,f) state-space model fits to a southern elephant seal track. Top panels (a,b) are plots of predicted states (red; regular 12-h time intervals) and observations (blue) with pre-filtered observations (orange; ignored by the SSM), using the `plot.fG_ssm` function. Panels c,d are time-series plots of the prediction residuals for the x and y coordinates of each fitted state. Panels e,f are autocorrelation functions of the prediction residuals. All residual plots generated using the `plot.fG_osar` function."}

load("../data/ex1.RData")

dat <- grab(fit.rw[1,], "d", as_sf = TRUE) |> 
  sf::st_transform("+proj=stere +lon_0=90 +units=km")
loc.rw <- grab(fit.rw[1,], "f", as_sf = TRUE) |>
  sf::st_transform("+proj=stere +lon_0=90 +units=km") 
line.rw <- loc.rw |>
  dplyr::group_by(id) |>
  dplyr::summarise(do_union = FALSE) |>
  sf::st_cast("MULTILINESTRING")
loc.crw <- grab(fit.crw[1,], "f", as_sf = TRUE) |>
  sf::st_transform("+proj=stere +lon_0=90 +units=km") 
line.crw <- loc.crw |>
  dplyr::group_by(id) |>
  dplyr::summarise(do_union = FALSE) |>
  sf::st_cast("MULTILINESTRING")

pA <- ggplot() +
  geom_sf(data = dat, 
             col = "dodgerblue", 
             size = 2) +
  geom_sf(data = line.rw,
            col = "orange",
            size = 1.5) +
  geom_sf(data = line.crw,
             col = "black",
             size = 0.6) +
  labs(x = element_blank(), y = element_blank()) +
  theme_minimal() +
  theme(axis.text = element_text(size = 6))

dist <- data.frame(dist = 
                     sf::st_distance(loc.rw, loc.crw, by_element = TRUE)
                   ) |>
  mutate(dist = as.numeric(dist))

pB <- ggplot(dist) +
  geom_histogram(aes(dist),
                 fill = grey(0.6),
                 col = "white",
                 bins = 20) +
  labs(x = "Distance (km)") +
  theme_minimal() +
  theme(axis.title = element_text(size = 8),
        axis.text = element_text(size = 6))


p1 <- plot(res.rw, "ts") + 
  xlab(element_blank()) + 
  ylab("Residuals") +
  theme(axis.text.x = element_text(size=6, angle=45), 
        axis.title.y = element_text(size = 8),
        strip.text.y = element_blank(),
        axis.title.x = element_blank())

p2 <- plot(res.rw, "acf") + 
  theme(strip.text.y = element_blank(),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))

p3 <- plot(res.crw, "ts") + 
  ylab(element_blank()) + 
  xlab(element_blank()) + 
  theme(axis.text.x = element_text(size=6, angle=45), 
        strip.text.y = element_blank(),
        axis.title.x = element_blank())

p4 <- plot(res.crw, "acf") + 
  ylab(element_blank()) + 
  theme(strip.text.y = element_blank(),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 8))

design <- "AABB
           CCDD
           EEFF"

wrap_plots(A=pA, B=pB, C=p1, D=p3, E=p2, F=p4, ncol = 2, design = design) + 
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 9))
```

## 3.2 | Inferring movement persistence from Argos and GPS data
Drawing on an expanded version of the data used in 3.1, we quality control and infer movement persistence, $\gamma_t$, along five southern elephant seal tracks. We fitted the `crw` SSM with a 24-h prediction interval using `fit_ssm` and assuming bivariate normal location measurement errors consistent with Argos Least-Squares-derived locations [@Jonsen:2020]. We used the SSM-predicted locations to estimate movement persistence jointly among the 5 seals using `fit_mpm` and visualise the behavioural index along the seals' tracks. The data can be accessed in `foieGras` via `data(sese, package = 'foieGras')`. As the estimation of $\gamma_t$ is sensitive to choice of time scale, we examined the influence of different prediction intervals (1 - 20 min) on the ability of the movement persistence model to resolve changes in movement pattern along the penguin tracks.

To illustrate how the method can accommodate other types of animal tracking data, we also infer $\gamma_t$ along six little penguin (*Eudyptula minor*) GPS tracks from Montague Island, NSW Australia, described in @Phillips:2021. The data are temporally irregular GPS locations that are assumed to have minimal measurement error. We fitted the `crw` SSM to predict temporally regular locations at 5-min intervals, assuming consistently small bivariate normal location measurement errors (ie. $\pm$ 10 m sd).

Movement persistence estimates along the quality-controlled southern elephant seal tracks highlight some fundamental differences in movement pattern among the seals. The two seals engaging in pelagic foraging trips (Fig. \ref{fig:ex33.1}a,c and f) had less contrast in their movements with consistently higher $\gamma_t$ estimates compared to the three seals engaging in trips to the fast-ice on the Antarctic shelf (Fig. \ref{fig:ex33.1}b,d-e and f). Although $\gamma_t$'s were higher overall for the pelagically foraging seals, they both spent little time making fast, highly directed movements ($\gamma_t \to 1$) relative to the shelf-foraging seals (\ref{fig:ex33.1}a,c vs b,d-e). This suggests the pelagically-foraging seals may spend considerable time searching for suitable foraging habitat in the highly variable eddy fields between the Subantarctic and Polar Fronts [@Jonsen:2019], whereas foraging habitat may be more predictable for seals travelling rapidly and directly to the Antarctic shelf region. These seals may also haulout periodically on available fast-ice to rest. This behaviour could also contribute to the higher contrast in movement persistence, relative to pelagically-foraging seals who would not have access to fast-ice.

Despite vastly different scales of movement, the time series of little penguin movement persistence estimates were broadly similar to those of the southern elephant seals (Fig. \ref{fig:ex33.2}a-e). The little penguin foraging trips likely reflect the underlying spatial distribution of their forage-fish prey, with spatially diffuse bouts of lower movement persistence potentially indicative of foraging both within and among neighbouring discrete prey patches [@Carroll:2017] (Fig. \ref{fig:ex33.2}f).

```{r ex33.1, echo=FALSE, message=FALSE, results='markup', fig.width=9, fig.height=7, cache=TRUE, fig.cap="\\label{fig:ex33.1} Inferred move persistence, $\\gamma_t$, 1-D time-series for five southern elephant seals (a-e; grey envelopes are 95 % CI's) and along their 2-D tracks (f; track labels, a-e, correspond to the 1-D time-series plots). Locations associated with low move persistence (blue) are indicative of slow, undirected movements, whereas high move persistence (yellow) is indicative of faster, directed movements. The lowest move persistence tends to occur at the distal end of foraging trips from the colony at Iles Kerguelen, suggesting these bouts of low movement persistence are associated with foraging activity. Due to the stereographic projection used and huge area covered in (f), the scale bar is not accurate in all regions and is indicative only."}
load("../data/ex33.RData")

p1 <- plot(fit, type = 3, pages = 1, ncol=3, ask=0) &
  theme(legend.position = "none")

m1 <- map(fit, 
          what = "p", 
          crs = "+proj=stere +lon_0=70 +units=km +datum=WGS84 +no_defs",
          map_type = "cartolight",
          zoom = 4,
          alpha = 0.5) +
  xlab(element_blank()) +
  ylab(element_blank()) +
  ggspatial::annotation_scale(height = unit(1.5, "mm"), aes(location = "br")) +
  theme(legend.position = c(0.88,0.9), legend.direction = "horizontal")

sf_locs <- grab(fit, what = "p", as_sf = TRUE) %>%
  sf::st_transform(., crs = m1$coordinates$crs)
bb <- sf::st_bbox(sf_locs)

label.df <- data.frame(tag = c("a","b","c","d","e"), 
                        x = c(1.03, 0.03, -0.03, 0.77, 0.53) * 
                         (bb["xmax"] - bb["xmin"]) + bb["xmin"],
                        y = c(0.56, 0.08, 0.68, 0.17, 0.3) * 
                         (bb["ymax"] - bb["ymin"]) + bb["ymin"])
m1 <- m1 + 
  geom_text(data = label.df, aes(x,y,label=tag))

p1 / m1 +
  plot_annotation(tag_levels = "a") +
  plot_layout(heights = c(1.5,3)) &
  theme(plot.title = element_blank())

```

```{r ex33.2, echo=FALSE, message=FALSE, results='markup', fig.width=9, fig.height=9, cache=TRUE, fig.cap="\\label{fig:ex33.2} Inferred move persistence, $\\gamma_t$, 1-D time-series (a-f; grey envelopes are 95 % CI's) and along little penguin GPS tracks (g). Colour palette as in \\ref{fig:ex33.1}. Movement persistence was  estimated from SSM-predicted locations with a regular 5-min interval."}
load("../data/ex33_lipe.RData")
class(fmp)[1] <- "mpm_df"
class(fit)[1] <- "ssm_df"

p <- plot(fmp, ncol = 1, pages = 1, ask = FALSE, pal = "Cividis") &
  theme(legend.position = "none",
        plot.title = element_blank())

peng.ssm_sf <- foieGras::grab(fit, "p", as_sf = TRUE) %>%
  mutate(g = foieGras::grab(fmp, "f")$g) 
bb <- sf::st_bbox(peng.ssm_sf)

m <- map(fit, 
                    fmp, 
                    what = "p", 
                    map_type = "cartolight", 
                    zoomin = 1, 
                    ext.rng = c(0.4, 0.05)) +
  ggspatial::annotation_scale(height = unit(0.15, "cm"), aes(location = "br")) +
  xlab(element_blank()) +
  ylab(element_blank()) +
  theme(legend.position = c(0.92,0.88))

label.df <- data.frame(tag = c("a","b","c","d","e"), 
                        x = c(0.1, 0.8, -0.05, 0.53, 0.9) * 
                         (bb["xmax"] - bb["xmin"]) + bb["xmin"],
                        y = c(0.9, 0.225, 0.5, 0.03, 0.6) * 
                         (bb["ymax"] - bb["ymin"]) + bb["ymin"])
m <- m + 
  geom_text(data = label.df, aes(x,y,label=tag))

## plot movement persistence 1-D time-series and map along 2-D tracks
design <- "
166
266
366
466
566"

p + m +
  plot_layout(design = design, guides = "keep") +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 11))
```

## 3.4 | Simulating tracks from `foieGras` model fits

To illustrate how to simulate tracks from `foieGras` model fits we use a sample of four juvenile harp seals (*Pagophilus groenlandicus*) tracked from the Gulf of St Lawrence, Canada, and described in @Grecian:2022. The data are temporally irregular Argos locations including error ellipse information. We fit the `crw` model using `fit_ssm` with a speed filter threshold (`vmax`) of 4 ms^-1^ and a 12-h time step.

From this process model we simulate 50 animal movement paths using `simfit` and apply a potential function using the `grad` and `beta` arguments to constrain the simulated paths to water. These tracks are then filtered based on their similarity to the original path using `sim_filter` and the top 10% retained (`keep = 0.1`)(Fig. \ref{fig:ex34}).

In combination, these functions provide a user-friendly method to generate and objectively filter pseudo-tracks for use in movement or habitat modelling applications.

```{r ex34, echo = FALSE, message = FALSE, results = 'markup', fig.width = 9, fig.height = 6, cache = TRUE, fig.cap = "\\label{fig:ex34} Simulating (a) 50 movement paths from a correlated random walk process model and then (b) filtering those tracks to select the top 10% based on their similarity to the original fitted track (shown in black). "}
# load track data
locs <- readRDS("../data/ex34.rds")
# load gradient rasters for simfit
load(system.file("extdata/grad.rda", package = "foieGras"))

fit <- fit_ssm(locs, 
               model = "crw", 
               time.step = 12, 
               vmax = 4, 
               control = ssm_control(verbose = 0))

trs <- foieGras::simfit(fit,
              what = "predicted",
              reps = 50,
              grad = grad,
              beta = c(-350, -350))

trs_flt <- foieGras::sim_filter(trs,
                      keep = .1,
                      flag = 2)

trs <- trs %>% 
  tidyr::unnest(cols = c(sims)) %>% 
  sf::st_as_sf(coords = c('lon', 'lat')) %>% 
  sf::st_set_crs(4326)

trs_flt <- trs_flt %>% 
  tidyr::unnest(cols = c(sims)) %>% 
  sf::st_as_sf(coords = c('lon', 'lat')) %>% 
  sf::st_set_crs(4326)

plocs <- foieGras::grab(fit, "predicted", as_sf = F)
plocs_sf <- plocs %>% 
  sf::st_as_sf(coords = c('lon', 'lat')) %>% 
  sf::st_set_crs(4326)

world_shp <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

# To generate a plot with less distortion first define a projection i.e. Lambert Azimuthal Equal Area
prj = "+proj=laea +lat_0=60 +lon_0=-50 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"

p1 <- ggplot() +
  theme_bw() +
  geom_sf(aes(), data = world_shp, colour = grey(0.6), fill = grey(0.6)) +
  geom_sf(aes(colour = factor(rep)), data = trs, size = 0.5) +
  scale_color_viridis_d(option = "cividis") +
  geom_sf(aes(), data = plocs_sf, size = 0.5) +
  coord_sf(xlim = c(-3500000, 5000000), 
           ylim = c(-4500000, 6000000), 
           crs = prj, 
           expand = T) +
  scale_x_continuous(breaks = seq(from = -180, to = 180, by = 20)) +
  scale_y_continuous(breaks = seq(from = 0, to = 90, by = 15)) +
  ggspatial::annotation_scale(height = unit(1.5, "mm"), aes(location = "br")) +
  facet_wrap(~id, ncol = 2) +
  theme(legend.position="none")

p2 <- ggplot() +
  theme_bw() +
  geom_sf(aes(), data = world_shp, colour = grey(0.6), fill = grey(0.6)) +
  geom_sf(aes(colour = factor(rep)), size = 0.5, data = trs_flt) +
  scale_color_viridis_d(option = "cividis") +
  geom_sf(aes(), data = plocs_sf, size = 0.5) +
  coord_sf(xlim = c(-3500000, 5000000), 
           ylim = c(-4500000, 6000000), 
           crs = prj, 
           expand = T) +
  scale_x_continuous(breaks = seq(from = -180, to = 180, by = 20)) +
  scale_y_continuous(breaks = seq(from = 0, to = 90, by = 15)) +
  ggspatial::annotation_scale(height = unit(1.5, "mm"), aes(location = "br")) +
  facet_wrap(~id, ncol = 2) +
  theme(legend.position="none")

p1 + p2 + plot_annotation(tag_levels = "a") & 
  theme(plot.tag = element_text(size = 11))

```



