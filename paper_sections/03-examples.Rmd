# 3 | Examples

```{r part_3_premble, include=FALSE}
#### Code for part 3: Examples ####
```
We illustrate the main capabilities of `foieGras` through a series of examples using real and simulated tracking data. These examples are purely for demonstration purposes and not intended as a comprehensive guide for conducting animal tracking data quality control or analysis with `foieGras`. Complete code for reproducing the examples and in-depth understanding of `foieGras` functions are provided as supplements.

## 3.1 | Southern Elephant seal - SSM validation with prediction residuals
We use a subadult male southern elephant seal track included in `foieGras` (`sese1`), sourced from from the Australian Integrated Marine Observing System (IMOS; data publicly available via [imos.aodn.org.au](http://imos.aodn.org.au)) deployments at Iles Kerguelen in collaboration with the French IPEV and SNO-MEMO programmes. We fit both the `rw` and `crw` models using `fit_ssm` with a speed filter threshold (`vmax`) of 4 ms^-1^ and a 12-h time step. We calculate prediction residuals using `osar`, and then use the generic `plot` method for `osar` residuals to assess and compare the model fits (Fig. \ref{fig:ex1}). The plots of predicted states on top of the observations suggests both models yield similar fits (Fig. \ref{fig:ex1}a,b), however, there are marked trends in the time-series of residuals for the `rw` model fit (Fig. \ref{fig:ex1}c) and the `rw` ACF's reveal consistent positive autocorrelation in the prediction residuals (Fig. \ref{fig:ex1}e). The corresponding `crw` prediction residuals show no apparent trends through time and have relatively little autocorrelation (Fig. \ref{fig:ex1}d,f), implying that the `crw` provides a better fit to the data.

```{r sese1 SSM, eval=FALSE, echo=FALSE}
fit.rw <- fit_ssm(sese1, vmax=4, model="rw", time.step=12, control=ssm_control(verbose=0))
res.rw <- osar(fit.rw)

fit.crw <- fit_ssm(sese1, vmax=4, model="crw", time.step=12, control=ssm_control(verbose=0))
res.crw <- osar(fit.crw)
```

```{r ex1, echo=FALSE, message=FALSE, results='markup', fig.width=8, fig.height=8, cache=TRUE, fig.cap="\\label{fig:ex1} Selected diagnostic plots for assessing `rw` (a,c,e) and `crw` (b,d,f) state-space model fits to a southern elephant seal track. Top panels (a,b) are plots of predicted states (red; regular 12-h time intervals) and observations (blue) with pre-filtered observations (orange; ignored by the SSM), using the `plot.fG_ssm` function. Panels c,d are time-series plots of the prediction residuals for the x and y coordinates of each fitted state. Panels e,f are autocorrelation functions of the prediction residuals. All residual plots generated using the `plot.fG_osar` function."}

load("../data/ex1.RData")

pA <- plot(fit.rw, "p", type = 2, pages=1, ask=0) + 
  labs(title = element_blank())
pB <- plot(fit.crw, "p", type = 2, pages=1, ask=0) + 
  labs(title = element_blank())
p1 <- plot(res.rw, "ts") + 
  xlab(element_blank()) + 
  theme(axis.text.x = element_text(size=7, angle=45), 
        strip.text.y = element_blank())
#p2 <- plot(res.rw, "qq")
p3 <- plot(res.rw, "acf") + 
  theme(strip.text.y = element_blank())

p4 <- plot(res.crw, "ts") + 
  ylab(element_blank()) + 
  xlab(element_blank()) + 
  theme(axis.text.x = element_text(size=7, angle=45), 
        strip.text.y = element_blank())
#p5 <- plot(res.crw, "qq")
p6 <- plot(res.crw, "acf") + 
  ylab(element_blank()) + 
  theme(strip.text.y = element_blank())

design <- "AABB
           AABB
           CCDD
           GGHH"
wrap_plots(A=pA, B=pB, C=p1, D=p4, G=p3, H=p6, ncol = 2, design = design) + 
  plot_annotation(tag_levels = "a")
```

## 3.2 | Assessing SSM robustness with simulated data
Using the `sim` function, we simulate animal movement tracks with a variety of plausible movement patterns. We use these simulated data to examine the SSM's goodness-of-fit to tracks generated by processes that differ from the `rw` and `crw` process models within the SSM. 

```{r ex2, echo=FALSE, message=FALSE, results='markup', fig.width=6, fig.height=6, cache=TRUE, fig.cap="\\label{fig:ex2} Animal tracks simulated from the movement persistence model `mpm` and a 2-state `crw` model."}

rmse <- readRDS("../data/ex32_rmse.RDS")

## plot overall normalised rmse's
ggplot(rmse, aes(SSM, nrmse, fill = SSM)) + 
  scale_fill_manual(values = c("#36476D", "#C6B76D")) + #from Cividis palette 
  geom_boxplot() + 
  facet_wrap(~sim, ncol=3) +
  ylim(0, 1.25) +
  theme_bw() + 
  xlab("SSM process model") +
  ylab("Normalised RMSE") +
  theme(legend.position = "none")


```


## 3.3 | Inferring movement persistence as an index of behaviour from Argos and GPS data
Drawing on an expanded version of the data used in 3.1, we quality control and infer movement persistence along five southern elephant seal tracks using the `fit_ssm` and `fit_mpm` functions. These data can be accessed in `foieGras` via the call: `data(sese, package = 'foieGras')`. To illustrate how the method can accommodate other types of animal tracking data, we also infer movement persistence along five little penguin (*Eudyptula minor*) GPS tracks from Montague Island, NSW Australia, described in @Phillips:2021. The GPS tags were programmed such that realized sampling rates were approximately 3 - 4 s, which results in extremely autocorrelated location time-series that are not amenable for movement persistence estimation. To alleviate this, we resampled the raw GPS data to approximately 5 min resolution using the `resample_track` function from the R package `amt` [@Signer:2019]. We then compare move persistence estimates obtained by fitting directly to the resampled GPS tracks versus those obtained from tracks that were interpolated from the raw GPS data to a fixed 5-min interval using the `fit_ssm` function.



```{r ex33.1, echo=FALSE, message=FALSE, results='markup', fig.width=9, fig.height=8, cache=TRUE, fig.cap="\\label{fig:ex33.1} Inferred move persistence, $\\gamma_t$, along southern elephant seal tracks. Locations associated with low move persistence (blue) are indicative of slow, undirected movements, whereas high move persistence (yellow) is indicative of faster, directed movements."}
load("../data/ex33_fmp.RData")

p1 <- plot(fmp, pages = 1, ncol=3, ask=0, pal = "Cividis") +
  theme(legend.position = "none")

sf_locs <- grab(fit, what = "p", as_sf = TRUE) %>%
  mutate(g = grab(fmp, what = "f")$g) %>%
  sf::st_transform(., crs = "+proj=stere +lon_0=70 +units=km +datum=WGS84 +no_defs") 
bb <- sf::st_bbox(sf_locs)

m1 <- ggplot(data = sf_locs) +
  ggspatial::annotation_map_tile("cartolight", zoom=4, alpha=0.5) +
  geom_sf(aes(colour = g), size = 0.75) +
  scale_colour_viridis_c(option = "E", limits = c(0,1)) +
  theme_minimal() +
  guides(colour = guide_colourbar(title = "g")) +
  coord_sf(xlim = c(bb["xmin"], bb["xmax"]), 
           ylim = c(bb["ymin"], bb["ymax"]),
           crs = "+proj=stere +lon_0=70 +units=km +datum=WGS84 +no_defs") +
  ggspatial::annotation_scale(height = unit(0.15, "cm"), aes(location = "br")) +
  theme(legend.position = "none") +
  xlab(element_blank()) +
  ylab(element_blank())

label.df <- data.frame(tag = c("a","b","c","d","e"), 
                        x = c(1.03, 0.03, -0.03, 0.77, 0.53) * 
                         (bb["xmax"] - bb["xmin"]) + bb["xmin"],
                        y = c(0.56, 0.08, 0.68, 0.17, 0.3) * 
                         (bb["ymax"] - bb["ymin"]) + bb["ymin"])
m1 <- m1 + 
  geom_text(data = label.df, aes(x,y,label=tag))

p1 / m1 +
  plot_annotation(tag_levels = "a") +
  plot_layout(heights = c(2,5), guides = "collect") &
  theme(plot.title = element_blank())

```

```{r ex33.2, echo=FALSE, message=FALSE, results='markup', fig.width=9, fig.height=10, cache=TRUE, fig.cap="\\label{fig:ex33.2} Inferred move persistence, $\\gamma_t$, along little penguin GPS tracks. Colour shading of locations as in \\ref{fig:ex33.1}. "}
load("../data/ex33_lipe.RData")

p1 <- plot(fmp, pages = 1, ncol = 2, ask = FALSE, pal = "Cividis") &
  theme(legend.position = "none")# &
#  ylab(element_blank())
p2 <- plot(fmp.crw5, pages = 1, ncol = 2, ask = FALSE, pal = "Cividis") &
  theme(legend.position = "none") #&
#  ylab(element_blank())

## compare mapped move persistence estimates
peng.sub_sf <- peng.sub %>%
  mutate(g = foieGras::grab(fmp, "f")$g) %>%
  sf::st_as_sf(., coords = c("lon","lat"), crs = 4326)
bb <- sf::st_bbox(peng.sub_sf)

m1 <- ggplot() +
  ggspatial::annotation_map_tile("cartolight", zoomin=0, alpha=0.5) +
  geom_sf(data = peng.sub_sf, aes(colour = g)) +
  scale_colour_viridis_c(option = "E", limits = c(0,1)) +
  theme_minimal() +
  guides(colour = guide_colourbar(title = expression(gamma[t]))) +
  coord_sf(xlim = extendrange(r=c(bb["xmin"], bb["xmax"]), f= 0.18), 
           ylim = extendrange(r=c(bb["ymin"], bb["ymax"]), f= 0.15),
           crs = 4326) +
  ggspatial::annotation_scale(height = unit(0.15, "cm"), aes(location = "br"))

peng.ssm_sf <- grab(fit, "p") %>%
  mutate(g = foieGras::grab(fmp.crw5, "f")$g) %>%
  sf::st_as_sf(., coords = c("lon","lat"), crs = 4326)
bb2 <- sf::st_bbox(peng.ssm_sf)

m2 <- ggplot() + 
  ggspatial::annotation_map_tile("cartolight", zoomin=0, alpha=0.5) +
  geom_sf(data = peng.ssm_sf, aes(colour = g)) +
  scale_colour_viridis_c(option = "E", limits = c(0,1)) +
  theme_minimal() +
  guides(colour = guide_colourbar(title = expression(gamma[t]))) +
  coord_sf(xlim = extendrange(r=c(bb2["xmin"], bb2["xmax"]), f= 0.18), 
           ylim = extendrange(r=c(bb2["ymin"], bb2["ymax"]), f= 0.15),
           crs = 4326)

## plot move persistence time-series & maps

(p1 | p2) /
   (m1 + m2 + plot_layout(ncol=2, guides = "collect") &
      theme(legend.position = "bottom")) +
  plot_layout(heights = c(4,6)) +
  plot_annotation(tag_levels = "a") &
  theme(plot.title = element_blank())
```

## 3.4 | Simulating tracks from `foieGras` model fits

