# 2 | `foieGras` overview

```{r part_2_premble, include=FALSE}
#### Code for part 2: foieGras Overview ####
```
The workflow for `foieGras` is deliberately simple, with many of the usual track data processing checks handled automatically. Here we outline the main aspects of the `foieGras` package. The package's main functions are listed in Table \ref{tab:func_table_kable} and a generalized workflow with example code is depicted in Figure \ref{fig:workflow}. 

```{r func_table, echo=FALSE, fig.width=5, fig.height=6, message=FALSE, warning=FALSE, cache=TRUE}
func_table <- data.frame(
  Function = c("fit_ssm", "fit_mpm", "grab", "osar", "map", "sim", "simfit", "sim_filter", "route_path", "plot.ssm_df", "plot.osar"),
  Description = c("Fit a State-Space Model to location data",
                  "Fit a Move Persistence Model to location data",
                  "Extract fitted/predicted/observed locations from a foieGras model, with or without projection information",
                  "Estimate One-Step-Ahead Residuals from a foieGras SSM",
                  "Map fitted/predicted locations with or without a defined projection",
                  "Simulate individual animal tracks with Argos LS or KF errors",
                  "Simulate animal tracks from SSM model fit objects",
                  "Filter simulated tracks according to similarity criteria",
                  "Reroute path so estimated locations are off land",
                  "Plot the fit of a foieGras SSM to data",
                  "Plot One-Step-Ahead Residuals from a foieGras SSM"
  ),
  Code = c("fit <- fit_ssm(data, model, time.step, ...)",
           "fmp <- fit_mpm(fit, model, ...)",
           "locs <- grab(fit, what = `predicted', ...)",
           "res <- osar(fit, ...)",
           "map(fit, fmp, what = `predicted', ...)",
           "slocs <- sim(N, model, ...)",
           "sfit <- simfit(fit, ...)",
           "sfit <- sim_filter(sfit, keep, ...)",
           "fit <- route_path(fit, what = `predicted', ...)",
           "plot(fit, what = `predicted', ...)",
           "plot(res, type = `ts')"
  )
)

```

```{r func_table_kable, echo=FALSE, fig.width=5, fig.height=6, message=FALSE, warning=FALSE, cache=TRUE, purl=FALSE}
kable(func_table, 
      format = table_out_format, 
      caption="Main \\texttt{foieGras} functions with description and example code. In the code examples, \\texttt{...} denotes optional arguments. Details on these arguments can be found in the package help files for each function.", 
      booktabs = TRUE) %>%
  column_spec(1, monospace = TRUE) %>%
  column_spec(2, latex_column_spec = ">{\\\\hangindent=2em}p{25em}" ) %>%
  column_spec(3, monospace = TRUE) %>%
kableExtra::landscape()
```

## 2.1 | Data preparation
Animal tracking data, consisting of a time-series of location coordinates, can be read into R as a data frame using standard functions such as `read.csv`. Possible input data formats are shown in Figure \ref{fig:workflow}. More details on input data formats are provided in the Overview vignette (https://ianjonsen.github.io/foieGras/articles/Overview.html). 

```{r fig 1, echo=FALSE, message=FALSE, results='markup', cache=TRUE, fig.cap="\\label{fig:workflow} A generalized \\texttt{foieGras} workflow showing required input data formats, model fitting, model checking/validation, visualisaiton of movement behaviour estimates, track simulation and re-routing around land. Example code is displayed for each stage."}
knitr::include_graphics("../figures/workflow_schematic_v2.png", dpi=455)
```

## 2.2 | State-space model fitting - `fit_ssm`
State-space models are fit using the function `fit_ssm`. The type of location data is automatically detected from the location quality class designations that are typical of Argos data and that can be added to the data by the researcher for other types of location data (Fig. \ref{fig:workflow}). Based on the location quality classes and optional information on measurement errors contained in the data, an appropriate measurement error model is selected for each observation [@Jonsen:2020]. Fits to single versus multiple individuals are handled automatically, with sequential SSM fits occurring in the latter case. No hierarchical or pooled estimation among individuals is currently available.

There are a large number of optional arguments that can be specified in `fit_ssm`, and these are explained in the documentation. We focus only the essential arguments here:  

- `data` the input data structured as illustrated in Fig. \ref{fig:workflow}
- `model` the process model to be used (one of `rw`, `crw`, or `mp`)
- `time.step` the prediction time interval (expressed in hours)

The function first invokes an automated data processing stage where the data type and measurement error model(s) are determined, observation times are sorted and checked for duplicates, and a speed filter identifies potential extreme locations to be ignored by the SSM. The SSM is then fit to the processed data, with the user-specified process model and automatically selected measurement error model. The likelihood is optimized numerically using either of the standard R optimizers, `optim` or `nlminb`. The R package `TMB`, Template Model Builder [@Kristensen:2016], is used to compute the gradient function in C++. A fit object is returned as a nested data frame, listing the individual animal id(s), basic convergence information and a list of model output including estimated parameters and states, processed data, and diagnostic information. A simple data frame of SSM fitted (location estimates corresponding to the observation times) or predicted values (locations predicted at regular `time.step` intervals) can be extracted using the `grab` function. Parameter estimates, AIC and other model fit information can be viewed using the `summary` function.

## 2.3 | Behavioural estimation - `fit_ssm`, `fit_mpm`
Move persistence, an index of movement behaviour, can be estimated as a continuous-valued (0 - 1), time-varying latent variable that represents changes in movement pattern based on autocorrelation in speed and direction [@Auger-Methe:2017,@Jonsen:2019]. There are two approaches in `foieGras` for estimating move persistence. The first is to use `fit_ssm` with `model = 'mp'`, which fits a continuous-time move persistence model in state-space form and thereby simultaneously estimates true locations and move persistence from the error-prone telemetry data. This approach is most appropriate for fitting to irregularly-timed and error-prone Argos data as both aspects are taken into account explicitly. The second is to use `fit_mpm`, which can take as input either location data or SSM-estimated locations from an `ssm_df` fit object. This approach is generally more appropriate when the data have minimal measurement error (e.g., GPS locations). 

## 2.4 | Model checking and visualization - `osar`, `plot`, `map`
Before using fitted or predicted locations, a `fit_ssm` model fit should be checked and visualized to confirm that the model adequately describes the data. There is no simple way to calculate residuals for latent variable models that have non-finite state-spaces and that may be nonlinear, but they can be computed based on iterative forecasts of the model [@Thygesen:2017]. The `osar` function computes one-step-ahead (prediction) residuals via the  `oneStepPredict` function from the `TMB` R package [@Kristensen:2016]. A set of residuals are calculated for the `x` and `y` values corresponding to the fitted values from the SSM. A generic `plot` (`plot.osar`) method provides an easy way to visualize the prediction residuals as time-series plots, quantile-quantile plots, or autocorrelation functions (Fig. \ref{fig:workflow}).

State-space model fits to data can also be visualised by using the generic `plot` (`plot.ssm_df`) function on a model fit object. Options exist to plot fitted or predicted values along with observations as either paired, 1-D time-series (using the `type = 1` argument), or as 2-D tracks (`type = 2`) with 95% confidence intervals or ellipses. These plots provide a rapid check on SSM fits to data. Additionally, when the fitted SSM is the move persistence model (i.e., `model = 'mp'`), 1-D time-series (`type = 3`) or 2-D track plots (`type = 4`) of move persistence estimates can be displayed (Fig. \ref{fig:workflow}).

`fit_ssm` model fits can be mapped using the `map` function for single or multiple individuals. By default, `map` uses the coastline data from the `rnaturalearth` R package [@rnaturalearth] at medium or high resolution, but can also use tiled maps for finer-scale detail, via the `rosm` [@rosm] and `ggspatial` [@ggspatial] R packages. Mapping aesthetics (e.g., plot symbols, sizes, colours, fills) can be customized via the `aes` argument and use of the `aes_lst` function (Fig. \ref{fig:workflow}). See code in SI for examples.

All `foieGras` visualizations draw on the `ggplot2` R package [@ggplot2], with multi-panel plots also using the `patchwork` R package [@patchwork], and generally can be modified through additive calls in the usual `ggplot2` manner. See code in SI for examples.

## 2.5 | Simulation - `sim`, `simfit`, `sim_filter`
Track simulation can be a helpful, yet informal, way of evaluating the degree to which statistical movement models capture essential features of animal movement data [@Michelot:2017]. The `sim` function can simulate a variety of movement process, including the `rw`, `crw`, and `mp` process models, as well as simple multiple movement state switching processes.

Simulation is also used frequently in habitat usage modelling to provide a measure of habitat availability [@Aarts:2012] by generating a source of 'background' points representing a null model of the distribution of foraging animals in the absence of external drivers [@Raymond:2015]. The `simfit` function extracts movement parameters from an SSM fit object and simulates random tracks of the same duration from these parameters. The argument `cpf = TRUE` allows simulation of central place foragers by ensuring that tracks start and end at approximately the same location. Movements can also be constrained to remain mostly in water via a potential function [@Preisler:2013], using included gradient rasters and the `grad` and `beta` arguments. These are illustrated in the code for Application 3.3.

The choice of null points can impact the performance of habitat suitability models [@Phillips:2009], and so the `sim_filter` function provides a tool to filter the simulated tracks based on their similarity to the original path. Filtering uses one of two metrics that capture the difference in the net displacement and bearing between the two paths (see `?similarity_flag` for more detail). These metrics are motivated by the 'flag value' described in @Hazen:2017. The the quantile of flag values to be retain is specified via the `keep` argument; i.e. `keep = 0.25` (the default) will return a `simfit` object containing those simulated tracks with flag values in the top 25% of values calculated for the input `simfit` object (Fig. \ref{fig:workflow}).

## 2.6 | Path rerouting - `route_path`
As the SSMs implemented in `foieGras` have no information about potential barriers to animal movement it is possible for locations to be estimated in implausible locations, such as on land for marine species. To overcome this, `foieGras` makes use of the `pathroutr` R package [@pathroutr] to efficiently re-route locations from land back to water by using visibility graphs [@Jan:2014]. The `route_path` function can be applied to either an SSM fit object or the simulations generated by `simfit`. When the input is an SSM fit object the re-routed path can be appended to the object for visualization and use in subsequent analyses. When the input is a `simfit` object the locations within the simulation are replaced with the re-routed paths (Fig. \ref{fig:workflow}). We illustrate the latter in Application 3.3. 
